<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="官方文档  https://docs.spring.io/spring-amqp/docs/2.0.1.RELEASE/reference/html/_reference.html#_introduction_4  简介用于管理与RabbitMQ代理的核心组件是ConnectionFactory接口。ConnectionFactory的实现类负责提供一个org.springframework.a">
<meta name="keywords" content="java,RabbitMq">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMq入门-连接和资源管理(3)">
<meta property="og:url" content="http://www.shuchang.sc.com/2018/01/29/RabbitMq入门-连接和资源管理-3/index.html">
<meta property="og:site_name" content="ShuChang&#39;s Blog">
<meta property="og:description" content="官方文档  https://docs.spring.io/spring-amqp/docs/2.0.1.RELEASE/reference/html/_reference.html#_introduction_4  简介用于管理与RabbitMQ代理的核心组件是ConnectionFactory接口。ConnectionFactory的实现类负责提供一个org.springframework.a">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcly1fnxha39o1fj30l209c74z.jpg">
<meta property="og:updated_time" content="2018-01-29T08:23:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RabbitMq入门-连接和资源管理(3)">
<meta name="twitter:description" content="官方文档  https://docs.spring.io/spring-amqp/docs/2.0.1.RELEASE/reference/html/_reference.html#_introduction_4  简介用于管理与RabbitMQ代理的核心组件是ConnectionFactory接口。ConnectionFactory的实现类负责提供一个org.springframework.a">
<meta name="twitter:image" content="https://ws4.sinaimg.cn/large/006tKfTcly1fnxha39o1fj30l209c74z.jpg">






  <link rel="canonical" href="http://www.shuchang.sc.com/2018/01/29/RabbitMq入门-连接和资源管理-3/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>RabbitMq入门-连接和资源管理(3) | ShuChang's Blog</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ShuChang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">剑来!</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">20</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类<span class="badge">17</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">69</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.shuchang.sc.com/2018/01/29/RabbitMq入门-连接和资源管理-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuchang">
      <meta itemprop="description" content="身怀利器，杀心自起，慎而重之">
      <meta itemprop="image" content="/images/123.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ShuChang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RabbitMq入门-连接和资源管理(3)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-29 13:44:43 / 修改时间：16:23:32" itemprop="dateCreated datePublished" datetime="2018-01-29T13:44:43+08:00">2018-01-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RabbitMq/" itemprop="url" rel="index"><span itemprop="name">RabbitMq</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/29/RabbitMq入门-连接和资源管理-3/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count gitment-comments-count" data-xid="/2018/01/29/RabbitMq入门-连接和资源管理-3/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>官方文档  <a href="https://docs.spring.io/spring-amqp/docs/2.0.1.RELEASE/reference/html/_reference.html#_introduction_4" target="_blank" rel="external">https://docs.spring.io/spring-amqp/docs/2.0.1.RELEASE/reference/html/_reference.html#_introduction_4</a></p>
</blockquote>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>用于管理与RabbitMQ代理的核心组件是ConnectionFactory接口。ConnectionFactory的实现类负责提供一个org.springframework.amqp.rabbit.connection.Connection的实例，它是com.rabbitmq.client.Connection的一个封装。官方提供的唯一的具体实现是CachingConnectionFactory。默认情况下，它建立一个可以被应用程序共享的连接代理(可以理解为一个全局配置)。因为与AMQP进行消息传递的“工作单元”实际上是一个“通道”（在某些方面，这与JMS中的Connection和Session之间的关系类似），所以可以共享连接。如你所想，连接实例提供了一个createChannel方法。 CachingConnectionFactory实现支持这些通道的高速缓存，并根据它们是否是事务处理来维护通道的单独高速缓存。在创建CachingConnectionFactory的实例时，可以通过构造函数提供主机名,用户名和密码。如果你想配置通道缓存的大小（默认是25），你也可以在这里调用setChannelCacheSize()方法.</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fnxha39o1fj30l209c74z.jpg" alt=""></p>
<p>可以看到一个SingleConnectionFactory实现类，它只在框架的单元测试代码中可用。它比CachingConnectionFactory简单，因为它不会缓存通道，但由于缺乏性能和弹性，它不适用于简单测试之外的实际应用。如果由于某种原因需要实现自己的ConnectionFactory，那么可以通过继承AbstractConnectionFactory来实现。</p>
<p>从版本1.3开始，CachingConnectionFactory可以缓存连接数也可以只缓存通道。在这种情况下，每次调用createConnection()都会创建一个新连接（或从缓存中检索一个空闲连接）。关闭连接会将其返回到缓存（如果尚未达到缓存大小）。在这样的连接上创建的通道也被缓存。</p>
<p>如果缓存大小为10，则可以使用任意数量的通道。如果超过10个通道正在使用，他们都返回到缓存，10将进入缓存;其余的将被关闭。</p>
<p>从版本1.6开始，默认通道高速缓存大小从1增加到25.在大容量，多线程环境中，缓存太小意味着频繁地创建和关闭通道。增加默认缓存大小将避免这种开销。可以通过RabbitMQ管理界面监视正在使用的频道，并且如果您看到许多频道正在创建和关闭，请考虑进一步增加缓存大小。缓存只能按需增长（以适应应用程序的并发需求），所以这种改变不会影响现有的低容量应用程序。</p>
<p>从版本1.4.2开始，CachingConnectionFactory有一个属性channelCheckoutTimeout。当此属性大于零时，channelCacheSize将成为可在连接上创建的通道数的最大值。如果达到限制，调用线程将阻塞，直到有一个通道可用或达到超时，在这种情况下会引发AmqpTimeoutException。</p>
<p><excerpt in="" index="" |="" 首页摘要=""></excerpt></p>
<ul>
<li><a id="more"></a>
<the rest="" of="" contents="" |="" 余下全文="">


</the></li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="标准的连接"><a href="#标准的连接" class="headerlink" title="标准的连接"></a>标准的连接</h4><p>如果没有使用spring框架创建通道，则需要手动的创建通道</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CachingConnectionFactory connectionFactory = new CachingConnectionFactory(&quot;somehost&quot;);</div><div class="line">connectionFactory.setUsername(&quot;guest&quot;);</div><div class="line">connectionFactory.setPassword(&quot;guest&quot;);</div><div class="line"></div><div class="line">Connection connection = connectionFactory.createConnection();</div></pre></td></tr></table></figure>
<p>XML配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;connectionFactory&quot;</div><div class="line">      class=&quot;org.springframework.amqp.rabbit.connection.CachingConnectionFactory&quot;&gt;</div><div class="line">    &lt;constructor-arg value=&quot;somehost&quot;/&gt;</div><div class="line">    &lt;property name=&quot;username&quot; value=&quot;guest&quot;/&gt;</div><div class="line">    &lt;property name=&quot;password&quot; value=&quot;guest&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>如果配置了rabbitmq的命名空间，也可以这样做。它会使用默认的配置创建一个CachingConnectionFactory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;rabbit:connection-factory id=&quot;connectionFactory&quot;/&gt;</div></pre></td></tr></table></figure>
<p>从版本2.0开始，为注入到AbstractionConnectionFactory提供了一个ConnectionNameStrategy。生成的名称用于目标RabbitMQ连接的应用程序特定标识。如果RabbitMQ服务器支持，连接名称将显示在管理UI中。该值不必是唯一的，并且不能用作连接标识符，例如在HTTP API请求中。该值应该是可以让人理解的，并且是connection_name键下的ClientProperties的一部分。可以简单的使用lambda表达式设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">connectionFactory.setConnectionNameStrategy(ConnectionFactory-&gt;&quot;MyConnection&quot;);</div></pre></td></tr></table></figure>
<p>当应用程序使用单个CachingConnectionFactory进行配置时，也就是默认情况下使用Spring Boot自动配置。当Broker(rabbitmq实例)阻止连接时，应用程序将停止工作。也就是说当Broker停止工作时，任何client也会无法使用。如果我们在同一个应用程序中有生产者和消费者，那么当生产者阻塞连接时，可能会导致死锁，因为Broker上没有资源，消费者也不能释放它们，因为连接被阻塞。为了缓解这个问题，需要再配置一个CachingConnectionFactory实例，一个用于生产者，一个用于消费者。分离的CachingConnectionFactory不推荐用于事务性生产者，因为事务性的生产者应该与消费者使用相同的通道。</p>
<h4 id="安全的连接-ssl"><a href="#安全的连接-ssl" class="headerlink" title="安全的连接(ssl)"></a>安全的连接(ssl)</h4><p>从版本1.4开始，提供了一个方便的RabbitConnectionFactoryBean，以便使用依赖注入方便地在底层客户端连接工厂中配置SSL属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;rabbit:connection-factory id=&quot;rabbitConnectionFactory&quot;</div><div class="line">    connection-factory=&quot;clientConnectionFactory&quot;</div><div class="line">    host=&quot;$&#123;host&#125;&quot;</div><div class="line">    port=&quot;$&#123;port&#125;&quot;</div><div class="line">    virtual-host=&quot;$&#123;vhost&#125;&quot;</div><div class="line">    username=&quot;$&#123;username&#125;&quot; password=&quot;$&#123;password&#125;&quot; /&gt;</div><div class="line"></div><div class="line">&lt;bean id=&quot;clientConnectionFactory&quot;</div><div class="line">        class=&quot;org.springframework.xd.dirt.integration.rabbit.RabbitConnectionFactoryBean&quot;&gt;</div><div class="line">    &lt;property name=&quot;useSSL&quot; value=&quot;true&quot; /&gt;</div><div class="line">    &lt;property name=&quot;sslPropertiesLocation&quot; value=&quot;file:/secrets/rabbitSSL.properties&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h4 id="Routing-Connection-Factory"><a href="#Routing-Connection-Factory" class="headerlink" title="Routing Connection Factory"></a>Routing Connection Factory</h4><p>从版本1.3开始，已经引入了AbstractRoutingConnectionFactory。这提供了一种机制来配置多个ConnectionFactory的映射，并在运行时通过一些lookupKey来确定目标ConnectionFactory。通常，实现检查线程绑定的上下文。为了方便起见，Spring AMQP提供了SimpleRoutingConnectionFactory，它从SimpleResourceHolder获取当前线程绑定的lookupKey。其核心的数据结构是一个Map<lookupkey,connection>，看一个使用demo</lookupkey,connection></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;connectionFactory&quot;</div><div class="line">      class=&quot;org.springframework.amqp.rabbit.connection.SimpleRoutingConnectionFactory&quot;&gt;</div><div class="line">	&lt;property name=&quot;targetConnectionFactories&quot;&gt;</div><div class="line">		&lt;map&gt;</div><div class="line">			&lt;entry key=&quot;#&#123;connectionFactory1.virtualHost&#125;&quot; ref=&quot;connectionFactory1&quot;/&gt;</div><div class="line">			&lt;entry key=&quot;#&#123;connectionFactory2.virtualHost&#125;&quot; ref=&quot;connectionFactory2&quot;/&gt;</div><div class="line">		&lt;/map&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;rabbit:template id=&quot;template&quot; connection-factory=&quot;connectionFactory&quot; /&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class MyService &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private RabbitTemplate rabbitTemplate;</div><div class="line"></div><div class="line">    public void service(String vHost, String payload) &#123;</div><div class="line">        SimpleResourceHolder.bind(rabbitTemplate.getConnectionFactory(), vHost);</div><div class="line">        rabbitTemplate.convertAndSend(payload);</div><div class="line">        SimpleResourceHolder.unbind(rabbitTemplate.getConnectionFactory());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也就是说这种连接工厂支持动态的绑定和解绑你所使用的连接，但是需要注意，在使用完资源之后一定要unbind，就像lock方法一定要进行unlock。</p>
<h4 id="队列亲和性以及LocalizedQueueConnectionFactory"><a href="#队列亲和性以及LocalizedQueueConnectionFactory" class="headerlink" title="队列亲和性以及LocalizedQueueConnectionFactory"></a>队列亲和性以及LocalizedQueueConnectionFactory</h4><p>在群集中使用高可用队列时，为了获得最佳性能，可能需要连接到主队列所在的物理地址。虽然CachingConnectionFactory可以配置多个地址，但这只是用于故障转移，客户端将尝试按顺序重新连接。 LocalizedQueueConnectionFactory使用admin plugin提供的REST API来确定哪个节点的队列被选为主队列。然后它创建（或从缓存中检索）一个将连接到该节点的CachingConnectionFactory。如果连接失败，则确定新的主节点，并且让客户连接到它。 LocalizedQueueConnectionFactory配置了一个默认的连接工厂，以防队列的物理位置无法确定，在这种情况下，它将正常连接到集群。</p>
<p>出于这个原因（使用队列名称进行查找），LocalizedQueueConnectionFactory只能在容器配置为侦听单个队列时使用。</p>
<p>给出一个springboot的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">@Autowired</div><div class="line">private RabbitProperties props;</div><div class="line"></div><div class="line">private final String[] adminUris = &#123; &quot;http://host1:15672&quot;, &quot;http://host2:15672&quot; &#125;;</div><div class="line"></div><div class="line">private final String[] nodes = &#123; &quot;rabbit@host1&quot;, &quot;rabbit@host2&quot; &#125;;</div><div class="line"></div><div class="line">@Bean</div><div class="line">public ConnectionFactory defaultConnectionFactory() &#123;</div><div class="line">    CachingConnectionFactory cf = new CachingConnectionFactory();</div><div class="line">    cf.setAddresses(this.props.getAddresses());</div><div class="line">    cf.setUsername(this.props.getUsername());</div><div class="line">    cf.setPassword(this.props.getPassword());</div><div class="line">    cf.setVirtualHost(this.props.getVirtualHost());</div><div class="line">    return cf;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Bean</div><div class="line">public ConnectionFactory queueAffinityCF(</div><div class="line">        @Qualifier(&quot;defaultConnectionFactory&quot;) ConnectionFactory defaultCF) &#123;</div><div class="line">    return new LocalizedQueueConnectionFactory(defaultCF,</div><div class="line">            StringUtils.commaDelimitedListToStringArray(this.props.getAddresses()),</div><div class="line">            this.adminUris, this.nodes,</div><div class="line">            this.props.getVirtualHost(), this.props.getUsername(), this.props.getPassword(),</div><div class="line">            false, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="消息发布确认与返回"><a href="#消息发布确认与返回" class="headerlink" title="消息发布确认与返回"></a>消息发布确认与返回</h4><p>通过将CachingConnectionFactory的publisherConfirms和publisherReturns属性分别设置为“true”来支持已确认和返回的消息。</p>
<p>当这些选项被设置时，由工厂创建的Channel被封装在一个PublisherCallbackChannel中，用于简化回调。当获得这样的channel时，客户端可以在channel上注册一个PublisherCallbackChannel.Listener。 PublisherCallbackChannel实现包含将确认/返回路由到合适的侦听器的逻辑。</p>
<h4 id="connectionListener和channelListener"><a href="#connectionListener和channelListener" class="headerlink" title="connectionListener和channelListener"></a>connectionListener和channelListener</h4><p>连接工厂支持注册ConnectionListener和ChannelListener实现。这使您可以接收有关connection和channel相关事件的通知。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">connectionFactory.setConnectionListeners();</div><div class="line">connectionFactory.setChannelListeners();</div></pre></td></tr></table></figure>
<h4 id="通道关闭事件日志"><a href="#通道关闭事件日志" class="headerlink" title="通道关闭事件日志"></a>通道关闭事件日志</h4><p>在1.5版本中引入了一个使用户能够控制日志级别的机制。</p>
<p>CachingConnectionFactory使用默认策略来记录通道关闭，如下所示：</p>
<p>正常通道关闭（200 OK）不记录。<br>如果通道由于被动队列声明失败而关闭，则会在调试级别进行记录。<br>如果由于独占消费者条件而导致basic.consume被拒绝，因此频道被关闭，则它将以INFO级别记录。<br>所有其他错误都记录在ERROR级别。</p>
<p>要修改此行为，请在其closeExceptionLogger属性中将自定义的ConditionalExceptionLogger注入到CachingConnectionFactory中。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这一节主要是讲了RabbitMq的核心ConnectionFactory的一些配置和要点，根据上面的讲述，自己配置一个ConnectionFactory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">public ConnectionFactory rabbitMqConnection()&#123;</div><div class="line">    CachingConnectionFactory connectionFactory = new CachingConnectionFactory();</div><div class="line">    connectionFactory.setHost(&quot;47.95.205.65&quot;);</div><div class="line">    connectionFactory.setPort(5672);</div><div class="line">    connectionFactory.setConnectionNameStrategy(ConnectionFactory-&gt;&quot;MyConnection&quot;);</div><div class="line">    connectionFactory.setVirtualHost(&quot;/&quot;);</div><div class="line">    connectionFactory.setUsername(&quot;admin&quot;);</div><div class="line">    connectionFactory.setPassword(&quot;123&quot;);</div><div class="line">    connectionFactory.setChannelCacheSize(25);</div><div class="line">    //单位是毫秒</div><div class="line">    connectionFactory.setChannelCheckoutTimeout(2000);</div><div class="line">    connectionFactory.setPublisherConfirms(true);</div><div class="line">    connectionFactory.setPublisherReturns(true);</div><div class="line">    connectionFactory.setCacheMode(CachingConnectionFactory.CacheMode.CHANNEL);</div><div class="line">    return connectionFactory;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
       
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>赏口饭吧</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="Shuchang 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Shuchang 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/RabbitMq/" rel="tag"># RabbitMq</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/22/JUC-Unsafe/" rel="next" title="JUC-Unsafe(7)">
                <i class="fa fa-chevron-left"></i> JUC-Unsafe(7)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/29/RabbitMq入门-AmqpTemplate-4/" rel="prev" title="RabbitMq入门-AmqpTemplate(4)">
                RabbitMq入门-AmqpTemplate(4) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/123.png"
                alt="Shuchang" />
            
              <p class="site-author-name" itemprop="name">Shuchang</p>
              <p class="site-description motion-element" itemprop="description">身怀利器，杀心自起，慎而重之</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">69</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://gitee.com/swiftsc" title="GitHub &rarr; https://gitee.com/swiftsc" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/shuchang0403@gmail.com" title="E-Mail &rarr; shuchang0403@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#标准的连接"><span class="nav-number">2.1.</span> <span class="nav-text">标准的连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安全的连接-ssl"><span class="nav-number">2.2.</span> <span class="nav-text">安全的连接(ssl)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Routing-Connection-Factory"><span class="nav-number">2.3.</span> <span class="nav-text">Routing Connection Factory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#队列亲和性以及LocalizedQueueConnectionFactory"><span class="nav-number">2.4.</span> <span class="nav-text">队列亲和性以及LocalizedQueueConnectionFactory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息发布确认与返回"><span class="nav-number">2.5.</span> <span class="nav-text">消息发布确认与返回</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#connectionListener和channelListener"><span class="nav-number">2.6.</span> <span class="nav-text">connectionListener和channelListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通道关闭事件日志"><span class="nav-number">2.7.</span> <span class="nav-text">通道关闭事件日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <a href="http://www.miitbeian.gov.cn" rel="noopener" target="_blank">浙ICP备17049505号 </a>&copy; 2015 – <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuchang</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'shuchaang',
            repo: 'shuchaang.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'cf8b60f5b29d873de44d218c0e4f31c0f8435a4f',
            
                client_id: 'c5aa96bb5e5656512174'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  

  

  

  

  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  

</body>
</html>
<script type="text/javascript" src="/js/src/love.js"></script>
